<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="keywords" content="computer, architecture">
<meta name="author" content="Cándido Aramburu">
<title>Estructura de Computadores  (240306)</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";



h1, h2, h3, h4, h5, h6, #toctitle,
.sidebarblock > .content > .title {
  color: rgba(221, 72, 20, 0.8);
}



</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!-- Change some CSS.
<style>
.imageblock{
  &.text-center > .title {
    text-align: center !important;
  }
}
</style>

-->

<style type="text/css"> .imageblock > .title { text-align: center; } </style>

<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="_subrutinas_2" class="book">
<div id="header">
<h1>Estructura de Computadores  (240306)</h1>
<div class="details">
<span id="author" class="author">Cándido Aramburu</span><br>
<span id="email" class="email"><a href="mailto:candido@unavarra.es">candido@unavarra.es</a></span><br>
<span id="revdate">2022-09-02</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="eecc_book.html">Estructura de Computadores  (240306)</a></span></p><ul class="sectlevel0">
<li><a href="_i_arquitectura_del_repertorio_de_instrucciones_isa_computadora_von_neumann_datos_instrucciones_programación.html">I Arquitectura del Repertorio de Instrucciones (ISA): computadora von Neumann, datos, instrucciones, programación.</a>
</li>
<li><a href="_ii_unidades_básicas_procesador_central_unidad_de_memoria_mecanismos_entradasalida.html">II Unidades Básicas: Procesador Central, Unidad de Memoria, Mecanismos Entrada/Salida.</a>
</li>
<li><a href="_iii_ejercicios_de_teoría.html">III Ejercicios de Teoría</a>
</li>
<li><a href="_iv_autoevaluación_teoría.html">IV Autoevaluación Teoría</a>
</li>
<li><a href="_v_guiones_de_prácticas_programación_ensamblador_x86.html">V Guiones de Prácticas: Programación Ensamblador x86</a>
<ul class="sectlevel1">
<li><a href="_introducción_a_la_programación_en_lenguaje_ensamblador_att_x86_32.html">12. Introducción a la Programación en Lenguaje Ensamblador AT&amp;T x86-32</a>
</li>
<li><a href="_representación_de_los_datos_2.html">13. Representación de los Datos</a>
</li>
<li><a href="_operaciones_aritméticas_y_lógicas.html">14. Operaciones Aritméticas y Lógicas</a>
</li>
<li><a href="_instrucciones_de_saltos_condicionales.html">15. Instrucciones de Saltos Condicionales</a>
</li>
<li><a href="_llamadas_al_sistema_operativo_kernel.html">16. LLamadas al Sistema Operativo (Kernel)</a>
</li>
<li><a href="_subrutinas_2.html"><span class="toc-current">17. Subrutinas</span></a>
<ul class="sectlevel2">
<li><a href="_subrutinas_2.html#_introducción_20">17.1. Introducción</a>
<ul class="sectlevel3">
<li><a href="_subrutinas_2.html#_objetivos_7">17.1.1. Objetivos</a>
</li>
</ul>
</li>
<li><a href="_subrutinas_2.html#_módulo_fuente_2">17.2. Módulo Fuente</a>
</li>
<li><a href="_subrutinas_2.html#_requisitos_7">17.3. Requisitos</a>
</li>
<li><a href="_subrutinas_2.html#_leeme_6">17.4. LEEME</a>
</li>
<li><a href="_subrutinas_2.html#_cuestiones_7">17.5. Cuestiones</a>
</li>
<li><a href="_subrutinas_2.html#_tamaño_de_los_datos_y_variables_2">17.6. Tamaño de los datos y variables</a>
<ul class="sectlevel3">
<li><a href="_subrutinas_2.html#_algoritmo_5">17.6.1. Algoritmo</a>
</li>
<li><a href="_subrutinas_2.html#_edición_del_módulo_fuente_summton_s">17.6.2. Edición del Módulo fuente: sumMtoN.s</a>
</li>
<li><a href="_subrutinas_2.html#_compilación_8">17.6.3. Compilación</a>
</li>
<li><a href="_subrutinas_2.html#_ejecución_8">17.6.4. Ejecución</a>
</li>
<li><a href="_subrutinas_2.html#_análisis_del_módulo_fuente_7">17.6.5. Análisis del módulo fuente</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="_imágenes_bit_map_portable.html">18. Imágenes: Bit Map Portable</a>
</li>
</ul>
</li>
<li><a href="_vi_hojas_de_referencia_rápida.html">VI Hojas de Referencia Rápida</a>
</li>
<li><a href="_vii_autoevaluación_prácticas.html">VII Autoevaluación Prácticas</a>
</li>
<li><a href="_viii_apéndices.html">VIII Apéndices</a>
</li>
<li><a href="_ix_bibliografía.html">IX Bibliografía</a>
</li>
<li><a href="_x_glosario.html">X Glosario</a>
</li>
<li><a href="_xi_colofón.html">XI Colofón</a>
</li>
<li><a href="_index.html">Index</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_subrutinas_2">17. Subrutinas</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introducción_20">17.1. Introducción</h3>
<div class="sect3">
<h4 id="_objetivos_7">17.1.1. Objetivos</h4>
<div class="sect4">
<h5 id="_programación_2">Programación</h5>
<div class="ulist">
<ul>
<li>
<p>Concepto de Subrutina en el  Lenguaje Ensamblador AT&amp;T x86-32</p>
</li>
<li>
<p>Instrucciones  de llamada y retorno: call y ret</p>
</li>
<li>
<p>Argumentos: Utilización de la pila</p>
</li>
<li>
<p>Instrucciones de pila:  push y pop</p>
</li>
<li>
<p>Estructura de la pila: punteros al bottom y top de la pila: registros EBP y ESP.</p>
</li>
<li>
<p>Anidamiento de llamadas: segmentación de la pila en segmentos "Frame".</p>
</li>
<li>
<p>Convenio de llamada: Pase de los parámetros, Valor de retorno, Dirección de retorno, Pila, Frame de la pila, Punteros al stack Frame, Epílogo, Prólogo</p>
</li>
<li>
<p>Directivas : .type sumMtoN, @function</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_análisis">Análisis</h5>
<div class="ulist">
<ul>
<li>
<p>Análisis de la pila mediante el depurador GDB</p>
<div class="ulist">
<ul>
<li>
<p>observar la generación de un nuevo frame</p>
</li>
<li>
<p>identificar los límites del frame a través de los registros puntero.</p>
</li>
<li>
<p>volcar los argumentos, dirección de retorno y valor de retorno de la subrutina en la pila.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_módulo_fuente_2">17.2. Módulo Fuente</h3>
<div class="ulist">
<ul>
<li>
<p>El módulo fuente <em>sumMtoN.s</em> realiza una llamada desde la rutina principal <em>_start</em> a la subrutina <em>sumMtoN</em> pasándole dos argumentos y recibiendo el resultado de la suma.</p>
</li>
<li>
<p>La subrutina sumMtoN realiza la suma desde el número entero M hasta el número entero N donde N&gt;M.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_requisitos_7">17.3. Requisitos</h3>
<div class="ulist">
<ul>
<li>
<p>Conceptos básicos de estructura de computadores.</p>
</li>
<li>
<p>Arquitectura básica intel x86-32.</p>
</li>
<li>
<p>Programación en lenguaje ensamblador AT&amp;T: práctica con datos, modos de direccionamiento e instrucciones básicas de transferencia, aritméticas y de saltos.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_leeme_6">17.4. LEEME</h3>
<div class="ulist">
<ul>
<li>
<p>Lectura del guión de prácticas  y del capítulo 3 del Libro Programming from the Ground-Up.</p>
</li>
<li>
<p><a href="_apéndice_prácticas.html#prac_apu">Apuntes y Libro de Texto</a></p>
</li>
<li>
<p><a href="_apéndice_prácticas.html#prac_doc_mem">Documentación Memoria</a>: Contenido y Formato de la Memoria</p>
</li>
<li>
<p><a href="_apéndice_prácticas.html#prac_eval">Evaluación</a>: sistema de evaluación</p>
</li>
<li>
<p><a href="_apéndice_prácticas.html#prac_plat_des">Plataforma de Desarrollo</a> : configuración de la computadora personal</p>
</li>
<li>
<p><a href="_apéndice_prácticas.html#prac_prog">Programación</a> : metodología</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cuestiones_7">17.5. Cuestiones</h3>
<div class="ulist">
<ul>
<li>
<p><a href="_apéndice_prácticas.html#prac_eval">"Autoevaluación de Prácticas"</a> opcional: <a href="_prácticas_cuestionario.html#prac_cues">Prácticas: Cuestionario</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tamaño_de_los_datos_y_variables_2">17.6. Tamaño de los datos y variables</h3>
<div class="sect3">
<h4 id="_algoritmo_5">17.6.1. Algoritmo</h4>
<div class="ulist">
<ul>
<li>
<p>Desarrollar un programa en lenguaje ensamblador de la arquitectura <em>i386</em> que realice la suma \(\sum_{i=1}^{N}i\) cuyo resultado es \(N(N+1)/2\)  utilizando el <a href="_apéndice_prácticas.html#prac_prog">método de programación</a> de descripción inicial en lenguaje pseudocódigo y organigrama. El programa debe de contener dos módulos: uno principal referenciado con el nombre <em>_start</em> y una subrutina denominada <em>sumMtoN</em> que realiza la suma. El programa principal pasa los paramétros M y N a la subrutina para una vez realizada la suma se devuelva el resultado de la suma como valor de retorno de la subrutina.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_edición_del_módulo_fuente_summton_s">17.6.2. Edición del Módulo fuente: sumMtoN.s</h4>
<div class="ulist">
<ul>
<li>
<p>Descargar el módulo fuente "sumMtoN.s" de miaulario y añadir los comentarios apropiados.</p>
<div class="listingblock">
<div class="content">
<pre>	/*
Programa: sumMtoN.s
Descripción: realiza la suma de números enteros de la serie M,M+1,M+2,M+3,...N
	función : sumMtoN(1º arg=M, 2º arg=N) donde M &lt; N
Ejecución:    Editar los valores M y N y compilar el programa.
	Ejecutar $./sumMtoN
	El resultado de la suma se captura del  sistema operativo con el comando linux: echo $?

	gcc -nostartfiles -m32 -g  -o sumMtoN sumMtoN.s
	Ensamblaje as --32 --gstabs sumMtoN.s -o sumMtoN.o
	linker -&gt; ld -melf_i386    -o sumMtoN  sumMtoN.o
	*/

	## MACROS
	.equ	SYS_EXIT,	1
	## DATOS
	.section .data

	## INSTRUCCIONES
	.section .text
	.globl _start
_start:
	## Paso los dos argumentos M y N a la subrutina a través de la pila
	pushl $10	#push    second argument -&gt; N
	pushl $5	#push    first argument  -&gt; M

	## Llamada a la subrutina sum1toN
	call  sumMtoN

	## Paso la salida de sum11toN al argumento a la llamada al sistema exit()
	mov  %eax, %ebx	  # (%ebx is returned)
	## Código de la llamada al sistema operativo
	movl  $SYS_EXIT, %eax	    # llamada exit
	## Interrumpo al S.O.
	int   $0x80

/*
Subrutina: sumMtoN
Descripción: calcula la suma de números enteros en secuencia desde el 1º sumando hasta el 2º sumando
	Argumentos de entrada: 1º sumando y 2º sumando
	los argumentos los pasa la rutina principal a través de la pila:
	1º se apila el último argumento y finalmente se apila el 1º argumento.
	Argumento de salida: es el resultado de la suma y se pasa a la rutina principal a través del registro EAX.
	Variables locales: se implementa una variable local en la pila pero no se utiliza
*/
	.type sumMtoN, @function # declara la etiqueta sumMtoN
sumMtoN:
	## Próĺogo: Crea el nuevo frame del stack
	pushl %ebp           #salvar el frame pointer antiguo
	movl  %esp, %ebp     #actualizar el frame pointer nuevo
	## Reserva una palabra en la pila como variable local
	## Variable local en memoria externa: suma
	subl  $4, %esp
	## Captura de argumentos
	movl  8(%ebp), %ebx  #1º argumento copiado en %ebx
	movl  12(%ebp), %ecx #2º argumento copiado en %ecx


	## suma la secuencia entre el valor del 1ºarg y el valor del 2ºarg
	## 1º arg &lt; 2ºarg
	## utilizo como variable local EDX en lugar de la reserva externa para variable local: optimiza velocidad
	## Inicializo  la variable local suma
	movl  $0,%edx

	## Número de iteracciones
	mov %ecx,%eax
	sub %ebx,%eax

bucle:
	add %ebx,%edx
	inc %ebx
	sub $1,%eax
	jns bucle

	## Salvo el resultado de la suma como el valor de retorno
	movl  %edx, %eax

	## Epílogo: Recupera el frame antiguo
	movl  %ebp, %esp      #restauro el stack pointer
	popl  %ebp            #restauro el frame pointer

	## Retorno a la rutina principal
	ret
	.end</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_compilación_8">17.6.3. Compilación</h4>
<div class="ulist">
<ul>
<li>
<p>Seguir los pasos del proceso de <a href="_apéndice_prácticas.html#compilacion">compilación</a> común a todas las sesiones.</p>
<div class="ulist">
<ul>
<li>
<p><code>gcc -nostartfiles -m32 -g -o sumMtoN sumMtoN.s</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ejecución_8">17.6.4. Ejecución</h4>
<div class="ulist">
<ul>
<li>
<p><code>./sumMtoN</code></p>
</li>
<li>
<p><code>echo $?</code></p>
</li>
<li>
<p>Comprobar que funciona correctamente cambiando los valores de los parámetros: 1º valor de la suma y 2º valor de la suma.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_análisis_del_módulo_fuente_7">17.6.5. Análisis del módulo fuente</h4>
<div class="ulist">
<ul>
<li>
<p>Leer en las hojas de referencia rápida el <a href="_programación_ensamblador_att_x86.html#programa_minimalista">Programa Ejemplo Minimalista</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_estructura_4">Estructura</h5>
<div class="ulist">
<ul>
<li>
<p>La estructura del programa esta formada por los siguientes elementos:</p>
<div class="ulist">
<ul>
<li>
<p>Cabecera</p>
</li>
<li>
<p>Definición de Macros</p>
</li>
<li>
<p>Sección de Datos</p>
</li>
<li>
<p>Sección de Instrucciones</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_ejecución_modo_paso_a_paso_mediante_el_depurador_gdb">Ejecución modo paso a paso mediante el depurador GDB</h5>
<div class="ulist">
<ul>
<li>
<p>Compilar el programa con la opción de generación de la tabla de símbolos requerida por el depurador y generar el módulo binario ejecutable:</p>
<div class="ulist">
<ul>
<li>
<p><code>gcc -nostartfiles -m32 -g  -o sumMtoN sumMtoN.s</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Abrir el depurador GDB, cargar el módulo binario ejecutable y comprobar que se carga la tabla de símbolos junto al módulo binario ejecutable.</p>
<div class="ulist">
<ul>
<li>
<p><code>gdb</code></p>
</li>
<li>
<p><code>file modulo_ejecutable</code></p>
</li>
<li>
<p><code>info sources</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Configurar el fichero para el logging histórico de los comandos.</p>
<div class="ulist">
<ul>
<li>
<p><code>set trace-commands on</code></p>
</li>
<li>
<p><code>set logging file sumMtoN_gdb_asm.txt</code></p>
</li>
<li>
<p><code>set logging on</code></p>
</li>
<li>
<p><code>shell ls -l sumMtoN_gdb_asm.txt</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Activar un punto de ruptura en la instrucción de entrada al programa.</p>
<div class="ulist">
<ul>
<li>
<p><code>b _start</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutar el programa deteniéndolo en la primera instrucción del programa.</p>
<div class="ulist">
<ul>
<li>
<p><code>run</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Sin ejecutar ninguna instrucción del programa</p>
<div class="ulist">
<ul>
<li>
<p>Estado de la pila</p>
<div class="ulist">
<ul>
<li>
<p>Top del stack: <code>x $esp</code> ó <code>x $sp</code> : stack pointer</p>
</li>
<li>
<p>Bottom del frame: <code>x $ebp</code> ó <code>x $fp</code> : frame pointer</p>
</li>
<li>
<p>Contenido del top de la pila (dirección sp): argc: número de argumentos string de la línea de comandos en ejecución</p>
<div class="ulist">
<ul>
<li>
<p><code>x /xw $sp</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Contenido una posición anterior al top de la pila (dirección sp+4): argv[0]: dirección del 1º string de la línea de comandos en ejecución</p>
<div class="ulist">
<ul>
<li>
<p><code>p /s *(char **)($sp+4)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutar las líneas necesarias hasta entrar en la subrutina:</p>
<div class="ulist">
<ul>
<li>
<p>Comando step: <code>s</code> ya que el comando <code>n</code> no entra en la subrutina sino que la ejecuta completamente.</p>
</li>
<li>
<p>¿A dónde apunta el stack pointer sp?¿Qué información contiene a donde apunta el sp?</p>
<div class="ulist">
<ul>
<li>
<p><code>x /i *(int *)$sp</code> : ¿qué instrucción es?</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutar el prólogo de la subrutina</p>
<div class="ulist">
<ul>
<li>
<p>Nuevo frame</p>
<div class="ulist">
<ul>
<li>
<p>Nuevo valor del frame pointer: <code>p $fp</code></p>
</li>
<li>
<p>Valor del stack pointer: <code>p $sp</code></p>
</li>
<li>
<p>Acceso a la dirección de retorno tomando como refefencia el nuevo frame pointer: <code>x /i *(int *)($fp+4)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutar la subrutina hasta obtener el valor de retorno</p>
<div class="ulist">
<ul>
<li>
<p>Imprimir el valor de retorno: <code>p $eax</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutar el epílogo de la subrutina</p>
<div class="ulist">
<ul>
<li>
<p>Valor del frame pointer: <code>p $fp</code></p>
</li>
<li>
<p>Valor del stack pointer: <code>p $sp</code></p>
</li>
<li>
<p>Dirección de retorno: <code>x *(int *)$sp</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Ejecutar la instrucción de retorno</p>
<div class="ulist">
<ul>
<li>
<p>Dirección del stack pointer: <code>p $sp</code></p>
<div class="ulist">
<ul>
<li>
<p>¿Por qué ha cambiado la dirección del stack pointer?</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Previous: <a href="_llamadas_al_sistema_operativo_kernel.html">LLamadas al Sistema Operativo (Kernel)</a> | ↑ Up: <a href="_v_guiones_de_prácticas_programación_ensamblador_x86.html">V Guiones de Prácticas: Programación Ensamblador x86</a> | ⌂ Home: <a href="eecc_book.html">Estructura de Computadores  (240306)</a> | Next: <a href="_imágenes_bit_map_portable.html">Imágenes: Bit Map Portable</a> →</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-09-02 15:42:44 +0200
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>